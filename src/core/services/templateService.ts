import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

/**
 * 模板服务，负责提供各类文档模板
 */
export class TemplateService {
  /**
   * 获取OKSDD.md模板
   */
  getOksddTemplate(): string {
    // 直接返回OKSDD.md的内容作为模板
    return `oksdd 工具规范文档（SDD实践辅助工具）

1. 概述

1.1 工具定位

oksdd 是一款面向“规范驱动开发（Specification-Driven Development, SDD）”的辅助工具，核心目标是通过标准化的文档管理、流程管控和校验能力，确保开发过程与需求规范高度一致。工具通过命令行接口（CLI）提供便捷操作，支持AI辅助执行流程中的文档生成、校验和流程推进工作。

1.2 核心价值

- 流程标准化：固化“提案-审核-执行-归档”四步流程，避免开发流程混乱

- 文档结构化：限定核心文档为 proposal（提案）、tasks（任务清单）、spec（规范增量），确保信息聚焦

- 校验自动化：通过命令行工具自动校验文档格式、内容完整性，减少人工核对成本

- AI可执行：明确各环节操作标准和文档格式，支持AI直接生成符合要求的内容并推进流程

2. 核心流程：提案-审核-执行-归档

oksdd 流程以“变更标识（change-id）”为核心串联，所有文档和操作均关联唯一 change-id，确保追溯性。change-id 命名规则：动词前缀-描述性名称，采用 kebab-case 格式，例如 add-user-login-otp、update-payment-api、remove-old-log-module，需确保全局唯一（重复时可追加数字，如 add-email-notify-2）。

2.1 阶段1：提案（Proposal）—— 明确“为什么改、改什么”

核心目标：输出结构化提案文档，清晰说明变更背景、内容和影响，为审核提供依据。此阶段由开发负责人或需求提出者主导，AI可辅助生成文档框架并校验格式。

2.1.1 核心操作

1. 创建变更目录及文档框架：执行 oksdd init [change-id]，工具将在oksdd/changes/目录下自动创建以该change-id命名的子目录，并生成proposal.md、tasks.md文件及spec/子目录（用于存放规范增量文档），无需手动创建。

1. 编写提案文档：基于工具生成的框架填充 proposal.md，核心内容包括“变更背景（Why）”“变更内容（What Changes）”“影响范围（Impact）”，其中破坏性变更需用BREAKING标记。

2. 编写任务清单：在 tasks.md 中拆分具体执行步骤，按“需求分析-方案设计-开发实现-测试验证”分类，每个任务需明确可交付成果（如“设计数据库表结构并输出SQL”）。

3. 编写规范增量：在 spec/[相关能力模块]/spec.md 中，以“增量”形式记录需求变更，使用 ADDED（新增）、MODIFIED（修改）、REMOVED（删除）作为一级标题，每个需求下必须包含至少一个 #### Scenario:（场景）描述，明确触发条件和预期结果。

4. 提案校验：执行 oksdd check [change-id]，工具自动校验proposal.md、tasks.md、spec增量文档的格式规范性，包括change-id唯一性、文档结构完整性、spec关键字使用及Scenario完整性等。

2.1.2 输出物

符合格式要求的 proposal.md、tasks.md、spec 增量文档，及 oksdd check [change-id] 校验通过的结果。

2.2 阶段2：审核（Approval）—— 确认“该不该改、能不能改”

核心目标：由技术负责人（审核技术可行性）和业务负责人（审核需求匹配度）共同审核提案，形成明确的通过/驳回结论，确保变更方向正确。AI可辅助整理审核要点并记录结果。

2.2.1 核心操作

1. 审核材料分发：将提案阶段输出的所有文档同步给审核人，明确审核重点（技术审核关注架构合理性、工作量评估；业务审核关注需求准确性、用户价值）。

2. 审核意见记录：在 proposal.md 末尾新增“审核意见”章节，记录每位审核人的结论（通过/驳回）及具体理由，驳回时需明确修改要求。

3. 审核结果确认：所有审核人达成一致意见后，在变更目录下创建 approval-result.md，记录最终结论（通过需所有审核人签字确认，驳回需明确修改方向）。

2.2.2 关键规则

- 审核未通过时，需返回提案阶段修改，修改后重新执行 oksdd check [change-id] 并再次提交审核。

- 只有审核通过的提案，才能进入执行阶段，禁止“先开发后审核”。

2.3 阶段3：执行（Implementation）—— 落实“怎么改、改得对不对”

核心目标：严格按照审核通过的 tasks 和 spec 执行开发，确保代码实现与规范一致。AI可辅助跟踪任务进度、生成测试用例并校验执行结果。

2.3.1 核心操作

1. 任务拆解与分配：基于 tasks.md 将开发任务分配至具体执行人，明确各任务的时间节点。

2. 按规范开发：开发过程中需严格遵循 spec 中的需求描述和场景定义，禁止偏离规范新增未定义功能。

3. 任务进度更新：完成单个任务后，在 tasks.md 中对应项前标记 - [x]，并补充执行说明（如“数据库表已创建，SQL文件路径：xxx”）。

4. 任务进度跟踪：AI定期检查 tasks.md 中的任务完成标记（- [x]）及执行说明，向团队同步进度，提醒未完成任务。

1. 规范匹配度校验：执行 oksdd check-spec [change-id]，工具比对代码实现与 spec 需求的一致性（需配合代码扫描插件，核心校验场景是否全部覆盖）。

2. 测试验证：基于 spec 中的场景编写测试用例，执行单元测试、集成测试，确保所有场景的预期结果均可复现。

2.3.2 输出物

完成开发的代码、更新后的 tasks.md（全量任务标记完成）、测试报告。

2.4 阶段4：归档（Archiving）—— 记录“改完了、留痕迹”

核心目标：将已完成执行的变更文档归档，更新项目主规范，确保历史变更可追溯、主规范与当前系统状态一致。AI可辅助执行归档操作并同步更新规范。

2.4.1 核心操作

1. 变更文档迁移：将变更目录（oksdd/changes/[change-id]）迁移至归档目录，命名格式为 oksdd/changes/archive/YYYY-MM-DD-[change-id]（YYYY-MM-DD 为归档日期）。

2. 主规范更新：将 spec 增量文档中的内容合并至项目主规范目录（oksdd/specs/[相关能力模块]/spec.md），其中 ADDED 内容直接新增、MODIFIED 内容覆盖原有需求、REMOVED 内容标注“已废弃及废弃原因”。

3. 归档记录：在 oksdd/archive-history.md 中新增一条记录，包含 change-id、变更内容摘要、归档日期、执行人信息，便于后续追溯。

4. 归档校验：AI或人工核对主规范更新完整性，确保spec增量内容无遗漏，无需工具命令介入。

2.4.2 输出物

归档后的变更目录、更新完成的项目主规范、archive-history.md 记录，及归档校验通过结果。

3. 核心文档结构

oksdd 仅保留三类核心文档，所有文档需使用 Markdown 格式，语言以中文为主，仅需求关键字（ADDED/MODIFIED/REMOVED）、命令、change-id 保留英文格式。

3.1 proposal.md 文档规范

核心用途：说明变更背景、内容和影响，为审核决策提供核心依据，是整个变更流程的起点文档。

必填内容：1. 变更标题，格式固定为“Change: [简明描述]”，如“Change: 新增用户登录双因素认证”；2. Why（变更背景），用1-2句话清晰说明当前存在的问题或待把握的机会；3. What Changes（变更内容），以项目符号列表形式呈现，其中破坏性变更需用BREAKING标识；4. Impact（影响范围），明确列出受影响的规范模块及核心代码文件路径；5. 审核意见，由AI或相关人员在审核阶段补充。

编写规范：语言需简洁精准，避免模糊表述，影响范围需具体到模块或文件级别，不可泛泛而谈。

3.2 tasks.md 文档规范

核心用途：将变更需求拆分为可执行的具体任务，明确开发过程中的步骤和交付物，作为执行阶段的核心指导文件。

必填内容：需按固定分类组织任务，包括“1. 需求分析”“2. 方案设计”“3. 开发实现”“4. 测试验证”四大类；每个任务需包含“[ ] 任务描述”和对应的“可交付物”说明，如“[ ] 设计数据库表结构 - 可交付物：用户认证模块SQL脚本”。

编写规范：任务颗粒度需适中，单个任务耗时建议控制在1-4小时；可交付物需具备可量化、可验证的特点，避免“完成相关开发”这类模糊表述。

3.3 spec/[模块]/spec.md 文档规范

核心用途：定义具体的需求规范，明确系统应具备的功能和行为，是开发实现和测试验证的直接依据，也是SDD思想的核心载体。

必填内容：1. 一级标题，固定使用ADDED（新增需求）、MODIFIED（修改需求）、REMOVED（删除需求）三类关键字；2. 二级标题，格式为“### Requirement: [需求名称]”，如“### Requirement: 手机验证码发送”；3. 需求描述，以“系统 SHALL/MUST”开头的规范性表述，明确系统义务；4. 场景描述，每个需求下必须包含至少一个“#### Scenario: [场景名称]”，内容需涵盖“WHEN（触发条件）”和“THEN（预期结果）”。

编写规范：需求表述需无歧义，确保开发和测试人员理解一致；每个Requirement必须对应至少一个Scenario；若为MODIFIED类型需求，需完整粘贴原有需求内容并清晰标注修改点，避免信息丢失。

4. CLI 核心命令（仅初始化与提案阶段使用）

oksdd 仅提供初始化和提案校验两类核心命令，均在项目根目录（含 oksdd/ 文件夹）下运行，支撑SDD流程的启动与提案规范校验。

4.1 初始化命令：oksdd init

功能描述：oksdd工具的核心初始化命令，承担双重职责：1. 项目首次引入时，生成oksdd工具规范文档（OKSDD.md）及基础目录结构（oksdd/根目录下包含changes/变更文档目录、specs/主规范目录、archive/归档目录）；2. 新增变更提案时，在oksdd/changes/目录下创建以唯一change-id命名的子目录，并自动生成proposal.md、tasks.md及spec/子目录的基础文档框架，无需手动创建。该命令仅在初始化项目或创建新提案时使用。

核心参数：[change-id]为可选参数，指定后生成对应变更的文档框架；[path]为可选参数，指定初始化路径（含OKSDD.md和oksdd目录），默认项目根目录；--update为可选参数，用于更新已存在的OKSDD.md及目录结构（保留自定义内容）。

使用示例：1. 项目首次初始化：oksdd init；2. 新增用户OTP功能提案：oksdd init add-user-otp；3. 更新规范文档：oksdd init docs/ --update。

4.2 提案校验命令：oksdd check [change-id]

功能描述：提案阶段的核心校验命令，专注校验proposal.md、tasks.md、spec增量文档的格式与内容规范性，是提案提交审核的前置要求。核心校验维度包括：change-id项目内唯一性；proposal.md必填章节（Why/What Changes/Impact）完整性；tasks.md任务分类（需求-设计-开发-测试）覆盖度；spec文档关键字（ADDED/MODIFIED/REMOVED）正确性及Scenario（WHEN/THEN）完整性。

核心参数：[change-id]为必填参数，指定待校验的变更标识；--strict为可选参数，启用后强化内容校验（如Scenario逻辑完整性、任务可交付物明确性）。

使用示例：严格校验OTP功能提案：oksdd check add-user-otp --strict。

oksdd 提供简洁的 CLI 命令，覆盖工具初始化及SDD全流程操作，支持 AI 直接调用执行。其中\`oksdd init\`独立于业务流程，其余命令需在项目根目录（含 oksdd/ 文件夹）下运行。
`;
  }

  /**
   * 获取proposal.md模板
   * @param changeId 变更标识
   */
  getProposalTemplate(changeId: string): string {
    return `# Change: [简明描述]

## Why

[1-2句话清晰说明当前存在的问题或待把握的机会]

## What Changes

- [变更内容1]
- [变更内容2]
- BREAKING: [破坏性变更，如有]

## Impact

- 影响模块1
- 影响文件路径：src/xxx/yyy.ts

## 审核意见

### 技术负责人审核
- 结论：[通过/驳回]
- 理由：[具体审核意见]

### 业务负责人审核
- 结论：[通过/驳回]
- 理由：[具体审核意见]
`;
  }

  /**
   * 获取tasks.md模板
   */
  getTasksTemplate(): string {
    return `# 任务清单

## 1. 需求分析

- [ ] 分析需求背景和目标 - 可交付物：需求分析文档
- [ ] 明确验收标准 - 可交付物：验收标准文档

## 2. 方案设计

- [ ] 设计技术方案 - 可交付物：技术方案文档
- [ ] 设计数据库结构（如有） - 可交付物：数据库设计文档
- [ ] 设计API接口（如有） - 可交付物：API设计文档

## 3. 开发实现

- [ ] 实现核心功能模块 - 可交付物：功能代码
- [ ] 编写单元测试 - 可交付物：测试用例
- [ ] 集成测试 - 可交付物：集成测试报告

## 4. 测试验证

- [ ] 功能测试 - 可交付物：功能测试报告
- [ ] 性能测试（如有） - 可交付物：性能测试报告
- [ ] 回归测试 - 可交付物：回归测试报告
`;
  }

  /**
   * 获取spec.md模板
   */
  getSpecTemplate(): string {
    return `# ADDED

## ### Requirement: [需求名称]

系统 SHALL/MUST [明确的需求描述]

#### Scenario: [场景名称]

**WHEN** [触发条件]
**THEN** [预期结果]

# MODIFIED

## ### Requirement: [需求名称]

系统 SHALL/MUST [修改后的需求描述]

#### Scenario: [场景名称]

**WHEN** [触发条件]
**THEN** [预期结果]

# REMOVED

## ### Requirement: [需求名称]

系统 SHALL/MUST [被移除的需求描述]

#### Scenario: [场景名称]

**WHEN** [触发条件]
**THEN** [预期结果]
`;
  }

  /**
   * 获取archive-history.md模板
   */
  getArchiveHistoryTemplate(): string {
    return `# 归档历史

| 日期       | Change-ID | 变更内容摘要 | 执行人 |
|------------|-----------|--------------|--------|
| YYYY-MM-DD | [change-id] | [变更内容摘要] | [执行人] |
`;
  }
}

// 单例实例
export const templateService = new TemplateService();